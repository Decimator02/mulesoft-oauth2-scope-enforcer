<?xml version="1.0" encoding="UTF-8"?>
<!-- 
#
# Copyright (c) 2017 The Trustees of Columbia University in the City of New York
# Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file
# except in compliance with the License. You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or
# implied. See the License for the specific language governing
# permissions and limitations under the License.
#
-->
<policy xmlns="http://www.mulesoft.org/schema/mule/policy"
   id="{{policyId}}"
   order="6000"
   policyName="OAuth 2.0 Scope Enforcement Policy"
   online="true"
   requiresContracts="true"
   xmlns:mule="http://www.mulesoft.org/schema/mule/core"
   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
   xmlns:scripting="http://www.mulesoft.org/schema/mule/scripting"
   xmlns:api-platform-gw="http://www.mulesoft.org/schema/mule/api-platform-gw"
   xsi:schemaLocation="http://www.mulesoft.org/schema/mule/policy http://www.mulesoft.org/schema/mule/policy/current/mule-policy.xsd
		       http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
		       http://www.mulesoft.org/schema/mule/scripting http://www.mulesoft.org/schema/mule/scripting/current/mule-scripting.xsd
		       http://www.mulesoft.org/schema/mule/api-platform-gw http://www.mulesoft.org/schema/mule/api-platform-gw/current/mule-api-platform-gw.xsd">

  <!-- Apply configurations to specific methods & resources: A pointcut for each configured condition. -->
  {{#pointcutData}}
  <pointcut>
    <api-platform-gw:api-pointcut apiName="{{ apiName }}" apiVersion="{{ apiVersionName }}"/>
    <resource methodRegex="{{ methodRegex }}" uriTemplateRegex="{{ uriTemplateRegex }}"/>
  </pointcut>
  {{/pointcutData}}

  <!-- Apply configurations to all API methods & resources: A single pointcut for everything. -->
  {{^pointcutData.length}}
  <pointcut>
    <api-platform-gw:api-pointcut apiName="{{ apiName }}" apiVersion="{{ apiVersionName }}"/>
  </pointcut>
  {{/pointcutData.length}}

  <mule:processor-chain xmlns:mule="http://www.mulesoft.org/schema/mule/core" name="invalidScopeViolation">
    <mule:logger message="Policy {{ policyId }} filtered the message #[message.getId()] based on OAuth 2.0 scope validation" level="INFO" />
    <mule:set-property propertyName="http.status" value="403"/>
    <mule:set-property propertyName="Content-Type" value="application/json"/>
    <mule:set-payload value='{ "error": "invalid_scope", "error_description" : "Policy {{ policyId }}: Access Token does not have the required scope(s): #[flowVars.requiredScopes]"}'/>
  </mule:processor-chain>
  <before>
    <scripting:component>
      <scripting:script engine="jython"><![CDATA[
import json
import re
# scopeMap key verb:resource is split into verb and re.compile(resource). Example:
#  'get:&#x2F;things':         {'verb': 'get', scope: 'read', 're': <_sre.SRE_Pattern object at 0x10aff68b0>},
#  'get:&#x2F;things&#x2F;.*': {'verb': 'get', scope: 'read', 're': <_sre.SRE_Pattern object at 0x104bec2e8>}, ...
scopeMap = {
{{#scopeMap}}
  '{{ key }}': {
    'verb': '{{ key }}'.split(':')[0],
    'scope': '{{ value }}',
    're': re.compile('{{ key }}'.split(':')[1])
  },
{{/scopeMap}}
}

enterpriseValidation = {
{{#enterpriseValidation}}
  '{{ key }}': '{{ value }}',
{{/enterpriseValidation}}
}

# dig the scope list out of the JSON map:
r = flowVars['_agwTokenContext']
map = json.loads(r) if r else {}
scope = map['scope'] if 'scope' in map else ''
scopeList = scope.split(' ')
# do enterprise scope validation
groupAttr = None
for e in enterpriseValidation:
  if e in scopeList:
    groupAttr = enterpriseValidation[e]
    break
if groupAttr and 'access_token' in map and groupAttr in map['access_token']:
  groups = map['access_token'][groupAttr]
  effective_scopelist = set(scopeList).intersection(set(groups.split(' ')))
  effective_scope = ' '.join(effective_scopelist)
  print("granted scopes: %s groups: %s -> effective scopes: %s"%(scope,groups,effective_scope))
  scope = effective_scope
flowVars['scope'] = scope # expose the scope to downstream app
# look for configured required scopes for this method and resource:
# strip the listener path out of the URL
#    http.listener.path=/v1/api/*
#     http.request.path=/v1/api/things
# TODO: deal with a pattern match when URI-params are involved (get:/things/{id}).
listenerPath = message.getInboundProperty('http.listener.path')
method = message.getInboundProperty('http.method').lower()
requestPath = message.getInboundProperty('http.request.path')
requiredScopes = ''
if requestPath.find(listenerPath[:-2]) == 0: # remove the '/*'
  resource = requestPath[len(listenerPath)-2:].replace('/','&#x2F;') # they HTML-quote the '/'
  print(scopeMap)
  for k,v in scopeMap.items():
    if v['verb'] == method and v['re'].match(resource):
      print('resource %s matches rule %s'%(resource,k))
      requiredScopes = v['scope']
      break
else:
  print("request path doesn't match listener path")
flowVars['requiredScopes'] = requiredScopes
flowVars['pyStatus'] = 200
if requiredScopes:
  if not set(requiredScopes.split(' ')).issubset(set(scope.split(' '))):
    print("Required Scopes are missing.")
    flowVars['pyStatus'] = 403
result=payload
]]>
      </scripting:script>
    </scripting:component>
    <mule:message-filter xmlns:mule="http://www.mulesoft.org/schema/mule/core" onUnaccepted="invalidScopeViolation">
      <mule:expression-filter xmlns:mule="http://www.mulesoft.org/schema/mule/core" expression="#[flowVars.pyStatus == 200]"/>
    </mule:message-filter>
    <mule:remove-variable variableName="pyStatus"/>
  </before>

</policy>
